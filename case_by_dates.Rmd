---
title: FLOVID-19
author: Ben Toh
date: '2020-05-22'
slug: flovid-19
categories: []
tags: []
---

This page contains some data visualization of COVID-19 in Florida. Last update: `r Sys.time()`. 

The "Event Date" of COVID-19 Cases is likely the day when a patient initiated the testing process, whereas the "Chart Date" seems to be when the test result confirm the patient is SARS-CoV-2 positive. The "Event Date" chart seems to yield better visualization in terms of understanding the pandemic in Florida than that of "Chart Date". The downside is that the median time between "Chart Date" and "Event Date" is currently hovering around 4 days -- The number of cases per event date is likely to be incomplete for about two weeks.

```{r message=FALSE, include=FALSE}
library(dplyr)
library(ggplot2)
library(readr)
library(tidyr)
library(lubridate)
library(stringr)

#### Setting up

## Dates
effective_date <- Sys.Date() - ddays(14) # 2 weeks of "unreliable time"
today_date <- as.character(Sys.Date()) %>%
  str_remove_all("-")

## Download of data and date formatting
in_file <- paste0("data/linelist_", today_date, ".csv")
download.file("https://opendata.arcgis.com/datasets/37abda537d17458bae6677b8ab75fcb9_0.csv",
              in_file)

line_list <- read_csv(in_file)

line_list$EventDate <- ymd_hms(line_list$EventDate) %>% as.Date
line_list$ChartDate <- ymd_hms(line_list$ChartDate) %>% as.Date

## Count number of cases by Event date
case_ev <- line_list %>%
  group_by(EventDate) %>%
  count %>%
  ungroup
case_ev <- complete(case_ev, EventDate = seq.Date(min(case_ev$EventDate), max(case_ev$EventDate), by = 1),
                fill = list(0)) %>%
  mutate(day = wday(EventDate, label = T),
         weekend = day %in% c("Sat", "Sun"),
         n = ifelse(is.na(n), 0, n))
case_ev$ma7 <- stats::filter(case_ev$n, rep(1/7, 7), sides = 1) # 7 day moving average

## Count number of cases by Chart date
case_ch <- line_list %>%
  group_by(ChartDate) %>%
  count %>%
  ungroup
case_ch <- complete(case_ch, ChartDate = seq.Date(min(case_ch$ChartDate), max(case_ch$ChartDate), by = 1),
                fill = list(0)) %>%
  mutate(day = wday(ChartDate, label = T),
         weekend = day %in% c("Sat", "Sun"),
         n = ifelse(is.na(n), 0, n))
case_ch$ma7 <- stats::filter(case_ch$n, rep(1/7, 7), sides = 1) # 7 day moving average
```

```{r echo=FALSE, fig.dim = c(9, 6)}
#### Plot Case vs Event Date

case_ev %>%
  filter(EventDate >= ymd("2020-03-01")) %>%
  ggplot() +
  geom_col(aes(x = EventDate, y = n, fill = as.factor(weekend))) +
  geom_line(aes(x = EventDate, y = ma7), lwd = 1.2) +
  # geom_vline(xintercept = ymd(effective_date), lty = 2, lwd = 1.2) +
  geom_rect(aes(xmin = ymd(effective_date), xmax = max(EventDate)+ddays(1), 
                ymin = -Inf, ymax = Inf), fill = "#333333", alpha = 0.01) +
  # xlim(c(ymd(c("2020-03-01")), max(tmp$EventDate))) +
  scale_fill_manual(name = "", labels = c("Weekday", "Weekend"),
                    values = c("#D55E00", "#0072B2")) +
  scale_x_date(expand=c(0,0), date_breaks = "1 week", date_labels = "%b-%d",
               limits = c(ymd("2020-02-29"), max(case_ev$EventDate)+ddays(1))) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, max(case_ev$n) + 100),
                     breaks = 0:4 * 250) +
  theme_bw() +
  theme(legend.position = "top") +
  labs(x = "Date", y = "Number of cases", 
       title = "Number of Cases by Event Date",
       subtitle = "Shaded region likely to be revised in coming days")
```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.dim = c(9, 6)}
#### Plot Case vs Chart Date

ggplot(case_ch) +
  geom_col(aes(x = ChartDate, y = n, fill = as.factor(weekend))) +
  geom_line(aes(x = ChartDate, y = ma7), lwd = 1.2) +
  scale_fill_manual(name = "", labels = c("Weekday", "Weekend"),
                    values = c("#D55E00", "#0072B2")) +
  scale_x_date(expand=c(0,0), date_breaks = "1 week", date_labels = "%b-%d",
               limits = c(ymd("2020-02-29"), max(case_ch$ChartDate)+ddays(1))) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, max(case_ch$n) + 100),
                     breaks = 0:6 * 250) +
  theme_bw() +
  theme(legend.position = "top") +
  labs(x = "Number of cases", y = "Date", 
       title = "Number of Cases by Confirmation (Chart) Date")

```

